{% extends "layouts/admin_base.html" %}
{% set page_title = "Reports" %}
{% set page_subtitle = "Filter shipments by date, courier, and status." %}
{% block admin_actions %}
    <a class="btn btn-outline-light btn-sm" href="{{ url_for('admin.dashboard') }}">Back to dashboard</a>
{% endblock %}
{% block admin_content %}
<form class="row g-3 mb-3">
    <div class="col-md-3">
        <label class="form-label">Start Date</label>
        <input type="date" name="start_date" class="form-control" value="{{ request.args.get('start_date','') }}">
    </div>
    <div class="col-md-3">
        <label class="form-label">End Date</label>
        <input type="date" name="end_date" class="form-control" value="{{ request.args.get('end_date','') }}">
    </div>
    <div class="col-md-3">
        <label class="form-label">Courier</label>
        <select name="courier_id" class="form-select">
            <option value="">Any</option>
            {% for courier in couriers %}
                <option value="{{ courier.id }}" {% if request.args.get('courier_id', type=int)==courier.id %}selected{% endif %}>
                    {{ courier.first_name }} {{ courier.last_name }}
                </option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-3">
        <label class="form-label">Status</label>
        <select name="status" class="form-select">
            <option value="">Any</option>
            {% for status in ["Created","Assigned","Picked up","Out for delivery","Delivered","Failed/Returned"] %}
                <option value="{{ status }}" {% if request.args.get('status')==status %}selected{% endif %}>{{ status }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-12">
        <button class="btn btn-primary">Apply Filters</button>
    </div>
</form>

<div class="row g-3">
    <div class="col-lg-6">
        <div class="p-3 border rounded bg-white shadow-sm">
            <h3 class="h6 mb-3">Shipments per Day</h3>
            <ul class="list-group list-group-flush">
                {% for day, count in shipments_per_day %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>{{ day }}</span>
                        <span class="fw-semibold">{{ count }}</span>
                    </li>
                {% else %}
                    <li class="list-group-item text-muted">No data.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="p-3 border rounded bg-white shadow-sm">
            <h3 class="h6 mb-3">Shipments per Courier</h3>
            <ul class="list-group list-group-flush">
                {% for first, last, count in shipments_per_courier %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>{{ first }} {{ last }}</span>
                        <span class="fw-semibold">{{ count }}</span>
                    </li>
                {% else %}
                    <li class="list-group-item text-muted">No data.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
<div class="mt-3 p-3 border rounded">
    <h3 class="h6">Delivered vs Total</h3>
    <p class="mb-0">Delivered: <strong>{{ delivered_shipments }}</strong> / Total: <strong>{{ total_shipments }}</strong></p>
</div>

<div class="mt-4">
    <h3 class="h6 mb-2">Filtered Shipments</h3>
    <div class="table-responsive">
        <table class="table table-sm table-striped align-middle">
            <thead>
                <tr>
                    <th>Tracking #</th>
                    <th>Customer</th>
                    <th>Courier</th>
                    <th>Status</th>
                    <th>Requested</th>
                </tr>
            </thead>
            <tbody>
                {% for item in shipments %}
                    <tr>
                        <td>{{ item.shipment.tracking_number }}</td>
                        <td>{{ item.shipment.customer.first_name }} {{ item.shipment.customer.last_name }}</td>
                        <td>{{ item.shipment.courier.first_name ~ ' ' ~ item.shipment.courier.last_name if item.shipment.courier else 'Unassigned' }}</td>
                        <td>{{ item.latest_status }}</td>
                        <td>{{ item.shipment.requested_date.strftime('%Y-%m-%d') }}</td>
                    </tr>
                {% else %}
                    <tr><td colspan="5" class="text-center text-muted">No shipments match filters.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
